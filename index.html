<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema de Limpeza</title>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 8px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .terms-footer {
            margin-top: 20px;
            text-align: center;
        }
        
        .terms-checkbox {
            margin: 20px 0;
            text-align: center;
        }

        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #f5c6cb;
        }

        .message.success {
            background-color: #d1edff;
            color: #155724;
            border-left: 4px solid #c3e6cb;
        }

        .message.warning {
            background-color: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffeeba;
        }
        
        .btn.loading {
            position: relative;
            color: transparent;
            pointer-events: none;
        }
        
        .btn.loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* ============================================= */
        /* SISTEMA DE AVISOS - POPUP ELEGANTE E COMPACTO */
        /* ============================================= */

        .alert-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .alert-modal-content {
            position: relative;
            background: white;
            margin: 10% auto;
            padding: 30px;
            width: 85%;
            max-width: 600px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideInUp 0.4s ease-out;
            border: 1px solid rgba(0,0,0,0.1);
        }

        @keyframes slideInUp {
            from { 
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .alert-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            position: relative;
        }

        .alert-modal-title {
            font-size: 1.6em;
            font-weight: 700;
            margin: 0;
            color: var(--primary-color);
            flex: 1;
            padding-right: 20px;
        }

        .alert-modal-close {
            background: none;
            border: none;
            color: rgba(0,0,0,0.5);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            font-weight: 300;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .alert-modal-close:hover {
            background-color: rgba(0,0,0,0.05);
            color: rgba(0,0,0,0.7);
        }

        .alert-modal-body {
            max-height: 50vh;
            overflow-y: auto;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) #f1f1f1;
        }

        .alert-modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .alert-modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .alert-modal-body::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }

        .alert-modal-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: rgba(0,0,0,0.7);
            margin-bottom: 20px;
            text-align: left;
        }

        .alert-modal-text.shouting {
            text-transform: uppercase;
            font-weight: 800;
            font-size: 1.3em;
            text-align: center;
            color: var(--accent-color);
            letter-spacing: 1px;
        }

        .alert-modal-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin: 15px auto;
            display: block;
            object-fit: contain;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert-modal-countdown {
            background-color: var(--warning-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1.1em;
            text-align: center;
            margin: 20px auto;
            display: inline-block;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .alert-modal-footer {
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
            text-align: center;
        }

        .alert-modal-link {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            padding: 10px 25px;
            border-radius: var(--border-radius);
            text-decoration: none;
            font-weight: 500;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            margin: 0 8px 10px 8px;
        }

        .alert-modal-link:hover {
            transform: translateY(-2px);
            background-color: #d63031;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            color: white;
        }

        .alert-modal-confirm {
            display: inline-block;
            background-color: var(--success-color);
            color: white;
            padding: 10px 25px;
            border-radius: var(--border-radius);
            text-decoration: none;
            font-weight: 500;
            font-size: 1em;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            margin: 0 8px 10px 8px;
        }

        .alert-modal-confirm:hover {
            transform: translateY(-2px);
            background-color: #219653;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .alert-modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .alert-modal-content {
                margin: 5% auto;
                width: 90%;
                padding: 25px 20px;
            }

            .alert-modal-title {
                font-size: 1.4em;
            }

            .alert-modal-text {
                font-size: 1em;
            }

            .alert-modal-text.shouting {
                font-size: 1.1em;
            }

            .alert-modal-countdown {
                font-size: 1em;
                padding: 10px 15px;
            }

            .alert-modal-actions {
                flex-direction: column;
                align-items: center;
            }

            .alert-modal-link,
            .alert-modal-confirm {
                width: 90%;
                text-align: center;
                margin: 5px 0;
            }

            .alert-modal-close {
                width: 30px;
                height: 30px;
                font-size: 1.3em;
            }
        }

        @media (max-width: 480px) {
            .alert-modal-content {
                padding: 20px 15px;
                border-radius: 12px;
            }

            .alert-modal-title {
                font-size: 1.3em;
            }

            .alert-modal-text {
                font-size: 0.95em;
            }

            .alert-modal-countdown {
                font-size: 0.95em;
                padding: 8px 12px;
            }

            .alert-modal-link,
            .alert-modal-confirm {
                padding: 8px 20px;
                font-size: 0.95em;
            }
        }

        .alert-modal.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Popup de Avisos Elegante e Compacto -->
    <div id="alertModal" class="alert-modal">
        <div class="alert-modal-content">
            <div class="alert-modal-header">
                <h2 id="alertModalTitle" class="alert-modal-title">Aviso do Sistema</h2>
                <button class="alert-modal-close" onclick="fecharPopupAviso()">√ó</button>
            </div>
            
            <div class="alert-modal-body">
                <div id="alertModalBody" class="alert-modal-text"></div>
                
                <img id="alertModalImage" class="alert-modal-image" style="display: none;" alt="Imagem do aviso">
                
                <div id="alertModalCountdown" class="alert-modal-countdown" style="display: none;"></div>
            </div>
            
            <div class="alert-modal-footer">
                <div class="alert-modal-actions">
                    <a id="alertModalLink" class="alert-modal-link" href="#" target="_blank" style="display: none;">
                        üìñ Saiba Mais
                    </a>
                    <button class="alert-modal-confirm" onclick="fecharPopupAviso()">
                        ‚úÖ Entendi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <a href="index.html">
                <img src="logo.svg" alt="INRB Logo" class="logo" style="cursor: pointer;">
            </a>
        </div>        
        
        <div class="login-box">
            <h1>Login - Escala de Limpeza</h1>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="turma">Turma:</label>
                    <select id="turma" name="turma" required>
                        <option value="" disabled selected>Selecione sua turma</option>
                        <option value="Formare 2025">Formare 2025</option>
                        <option value="Aprender A+ (Ter√ßa-Feira)">Aprender A+ (Ter√ßa-Feira)</option>
                        <option value="Aprender A+ (Quarta-Feira)">Aprender A+ (Quarta-Feira)</option>
                        <option value="Aprender A+ (Quinta-Feira)">Aprender A+ (Quinta-Feira)</option>
                        <option value="Inform√°tica (Atividade complementar)">Inform√°tica (Atividade complementar)</option>
                        <option value="Ingl√™s (Atividade complementar)">Ingl√™s (Atividade complementar)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edv">EDV:</label>
                    <input type="number" id="edv" name="edv" placeholder="Digite seu EDV" required 
                           pattern="[0-9]*" inputmode="numeric">
                </div>
                
                <div class="terms-checkbox">
                    <input type="checkbox" id="acceptTerms" required>
                    <label for="acceptTerms">Eu li e aceito os <a href="javascript:void(0)" id="termsLink">Termos de Uso</a></label>
                </div>
                
                <div style="text-align: center; margin-top: 10px;">
                    <a href="https://forms.gle/9Rg6abPqrVmX5dgNA" target="_blank" style="color:#000000; text-decoration: underline; font-weight: bold;">
                        Seu EDV n√£o est√° Cadastrado? Cadastre!
                    </a>
                </div>
                
                <button type="submit" class="btn" id="loginButton">Entrar</button>
            </form>
            
            <div id="message" class="message"></div>
            <div id="attemptsWarning" class="message warning" style="display: none;"></div>
        </div>
    </div>
    
    <div id="termsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Termos de Uso</h2>
            <p><strong>√öltima atualiza√ß√£o: 20 de abril de 2025</strong></p>
            <p>Ao acessar e utilizar o site <strong>Escala de Limpeza do Formare</strong>, voc√™ concorda com os segurentos Termos de Uso. Se n√£o concordar com algum deles, recomendamos n√£o utilizar o site.</p>
            <h3>1. Objetivo do site</h3>
            <p>Este site foi criado para organizar e facilitar a consulta da escala de limpeza da sala do Formare. A ideia √© manter nosso ambiente limpo, organizado e agrad√°vel para todos, incentivando o cuidado coletivo com o espa√ßo que compartilhamos todos os dias.</p>
            <h3>2. Acesso ao sistema</h3>
            <p>O acesso √© feito apenas por login, com base nas informa√ß√µes cadastradas previamente no sistema. N√£o h√° necessidade de criar conta ou fornecer dados al√©m dos que j√° foram disponibilizados pela turma.</p>
            <h3>3. Uso adequado</h3>
            <p>Este site deve ser utilizado apenas para ver a escala de limpeza. Qualquer tentativa de alterar informa√ß√µes ou acessar √°reas indevidas poder√° levar ao bloqueio do acesso, incluindo bloqueios baseados no IP do usu√°rio em casos de tentativas repetidas de acesso indevido.</p>
            <h3>4. Privacidade</h3>
            <p>As informa√ß√µes utilizadas, como nome, EDV e turma, s√£o usadas apenas dentro do pr√≥prio sistema da escala. Nenhum dado ser√° exposto ou compartilhado fora do grupo da turma.</p>
            <h3>5. Conte√∫do do site</h3>
            <p>Todo o conte√∫do deste site ‚Äî como textos, imagens, layout e c√≥digo ‚Äî foi feito exclusivamente para uso da turma do Formare. Pedimos que n√£o seja copiado ou alterado sem permiss√£o.</p>
            <h3>6. Atualiza√ß√µes</h3>
            <p>Os Termos de Uso podem ser ajustados se necess√°rio. Qualquer mudan√ßa ser√° comunicada diretamente na p√°gina.</p>
            <h3>7. Sobre o projeto</h3>
            <p>Este site foi desenvolvido por <strong>Erick Matheus</strong>, aluno do <strong>Formare 2025</strong>, com a inten√ß√£o de facilitar a organiza√ß√£o da turma e promover um ambiente mais limpo e colaborativo.</p>
            <h3>8. Contato</h3>
            <p>Se tiver d√∫vidas ou sugest√µes, entre em contato comigo pelo e-mail: 
                <a href="mailto:erickleguisamon@gmail.com">erickleguisamon@gmail.com</a> 
                ou pelo WhatsApp:
                <a href="https://wa.me/5541998239031" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none; color: #ec3333; font-weight: bold;">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="width: 20px; height: 20px; margin-right: 5px;">
                  Fale comigo (Erick)
                </a>
            </p>            
            <div class="terms-footer">
                <button id="acceptTermsBtn" class="btn">Aceitar Termos</button>
            </div>
        </div>
    </div>
    
    <footer onclick="window.open('https://www.institutorobertbosch.org.br/', '_blank')" style="cursor: pointer;">
        &copy; 2025 INRB. Todos os direitos reservados.
    </footer>
    
    <script>
        // Configura√ß√µes
        const API_URL = 'https://erickmth.pythonanywhere.com';
        let currentAlert = null;
        let alertCheckInterval = null;

        // Vari√°veis do sistema de bloqueio
        let loginAttempts = 0;
        let blockedUntil = 0;
        let nextBlockDuration = 1 * 60 * 1000;

        // Inicializa√ß√£o quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            setupModalTerms();
            loadBlockState();
            
            // Configurar formul√°rio de login
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                
                if (loginAttempts >= 2) showAttemptsWarning();
                if (blockedUntil > 0) {
                    const remaining = Math.ceil((blockedUntil - Date.now()) / (60 * 1000));
                    showMessage(`‚è≥ Acesso bloqueado. Tente novamente em ${remaining} minuto(s).`, 'error');
                }
            }
            
            // Verificar avisos imediatamente e abrir popup se houver
            checkForAlerts();
            
            // Verificar avisos a cada 30 segundos
            alertCheckInterval = setInterval(checkForAlerts, 30000);
        });

        // =============================================
        // SISTEMA DE LOGIN E BLOQUEIO
        // =============================================

        function checkBlockExpiration() {
            const now = Date.now();
            
            if (blockedUntil > 0 && now >= blockedUntil) {
                loginAttempts = 0;
                blockedUntil = 0;
                nextBlockDuration = 1 * 60 * 1000;
                localStorage.removeItem('loginAttempts');
                localStorage.removeItem('blockedUntil');
                localStorage.removeItem('nextBlockDuration');
                return false;
            }
            
            return blockedUntil > 0;
        }

        function blockUser() {
            const now = Date.now();
            blockedUntil = now + nextBlockDuration;
            
            if (loginAttempts >= 15) nextBlockDuration = 2 * 60 * 60 * 1000;
            else if (loginAttempts >= 10) nextBlockDuration = 30 * 60 * 1000;
            else if (loginAttempts >= 5) nextBlockDuration = 1 * 60 * 1000;
            
            localStorage.setItem('blockedUntil', blockedUntil.toString());
            localStorage.setItem('loginAttempts', loginAttempts.toString());
            localStorage.setItem('nextBlockDuration', nextBlockDuration.toString());
        }

        function loadBlockState() {
            const storedBlockedUntil = localStorage.getItem('blockedUntil');
            const storedAttempts = localStorage.getItem('loginAttempts');
            const storedDuration = localStorage.getItem('nextBlockDuration');
            
            if (storedBlockedUntil) blockedUntil = parseInt(storedBlockedUntil);
            if (storedAttempts) loginAttempts = parseInt(storedAttempts);
            if (storedDuration) nextBlockDuration = parseInt(storedDuration);
            
            checkBlockExpiration();
        }

        function showAttemptsWarning() {
            const warningEl = document.getElementById('attemptsWarning');
            
            if (loginAttempts >= 2 && loginAttempts < 5) {
                warningEl.textContent = `‚ö†Ô∏è Voc√™ teve ${loginAttempts} tentativas incorretas. Ap√≥s ${5 - loginAttempts} tentativas, ser√° bloqueado por 1 minuto.`;
                warningEl.style.display = 'block';
                
                setTimeout(() => {
                    warningEl.style.display = 'none';
                }, 5000);
            } else {
                warningEl.style.display = 'none';
            }
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const loginButton = document.getElementById('loginButton');
            loginButton.classList.add('loading');
            loginButton.disabled = true;
            
            // Verificar termos aceitos
            const acceptTerms = document.getElementById('acceptTerms').checked;
            if (!acceptTerms) {
                showMessage('‚ùå Voc√™ deve aceitar os termos de uso para continuar.', 'error');
                loginButton.classList.remove('loading');
                loginButton.disabled = false;
                return;
            }
            
            // Verificar bloqueio
            if (checkBlockExpiration()) {
                const remaining = Math.ceil((blockedUntil - Date.now()) / (60 * 1000));
                showMessage(`‚è≥ Acesso bloqueado. Tente novamente em ${remaining} minuto(s).`, 'error');
                loginButton.classList.remove('loading');
                loginButton.disabled = false;
                return;
            }
            
            const turma = document.getElementById('turma').value;
            const edv = document.getElementById('edv').value;
            
            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ turma, edv })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Login bem-sucedido
                    loginAttempts = 0;
                    localStorage.removeItem('loginAttempts');
                    localStorage.removeItem('blockedUntil');
                    localStorage.removeItem('nextBlockDuration');

                    // Salvar dados na sessionStorage
                    sessionStorage.setItem('nome', data.nome);
                    sessionStorage.setItem('admin', data.is_admin);
                    sessionStorage.setItem('turma', turma);

                    showMessage('‚úÖ Login realizado com sucesso! Redirecionando...', 'success');

                    // Determinar p√°gina de destino baseado na turma (EXATAMENTE como no script.js)
                    let page = 'index.html';
                    if (turma.includes('Formare')) page = 'formare.html';
                    else if (turma.includes('Ter√ßa')) page = 'aprender_terca.html';
                    else if (turma.includes('Quarta')) page = 'aprender_quarta.html';
                    else if (turma.includes('Quinta')) page = 'aprender_quinta.html';
                    else if (turma.includes('Inform√°tica')) page = 'informatica.html';
                    else if (turma.includes('Ingl√™s')) page = 'ingles.html';
                    
                    // Redirecionar ap√≥s breve delay
                    setTimeout(() => {
                        window.location.href = page;
                    }, 1500);
                    
                } else {
                    // Login falhou
                    loginAttempts++;
                    localStorage.setItem('loginAttempts', loginAttempts.toString());
                    
                    if (loginAttempts >= 5) {
                        blockUser();
                        showMessage('üîí Acesso bloqueado por 1 minuto devido a muitas tentativas falhas.', 'error');
                    } else {
                        showMessage('‚ùå EDV ou turma incorretos. Verifique suas credenciais.', 'error');
                        showAttemptsWarning();
                    }
                }
            } catch (error) {
                showMessage('üåê Erro de conex√£o com o servidor. Tente novamente.', 'error');
                console.error('Erro:', error);
            } finally {
                loginButton.classList.remove('loading');
                loginButton.disabled = false;
            }
        }

        // =============================================
        // MODAL DE TERMOS
        // =============================================

        function setupModalTerms() {
            const termsModal = document.getElementById('termsModal');
            const termsLink = document.getElementById('termsLink');
            const closeBtn = document.querySelector('.close');
            const acceptTermsBtn = document.getElementById('acceptTermsBtn');
            const acceptTermsCheckbox = document.getElementById('acceptTerms');

            // Abrir modal ao clicar no link dos termos
            if (termsLink && termsModal) {
                termsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    termsModal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
            }

            // Fechar modal ao clicar no X
            if (closeBtn && termsModal) {
                closeBtn.addEventListener('click', function() {
                    termsModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                });
            }

            // Fechar modal ao clicar fora
            if (termsModal) {
                window.addEventListener('click', function(event) {
                    if (event.target === termsModal) {
                        termsModal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }

            // Aceitar termos e fechar modal
            if (acceptTermsBtn && acceptTermsCheckbox && termsModal) {
                acceptTermsBtn.addEventListener('click', function() {
                    acceptTermsCheckbox.checked = true;
                    termsModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                });
            }
        }

        // =============================================
        // SISTEMA DE AVISOS - POPUP ELEGANTE E COMPACTO
        // =============================================

        // Verificar se h√° avisos ativos
        async function checkForAlerts() {
            try {
                const response = await fetch(`${API_URL}/api/public/alerts/active`);
                
                if (!response.ok) {
                    throw new Error('Erro ao verificar avisos');
                }

                const alertData = await response.json();
                
                if (alertData.active && alertData.id !== currentAlert?.id) {
                    currentAlert = alertData;
                    showAlertModal(alertData);
                } else if (!alertData.active && currentAlert) {
                    currentAlert = null;
                    hideAlertModal();
                }
                
            } catch (error) {
                console.error('Erro ao verificar avisos:', error);
                if (currentAlert) {
                    hideAlertModal();
                }
            }
        }

        // Mostrar modal de avisos automaticamente
        function showAlertModal(alertData) {
            const modal = document.getElementById('alertModal');
            const title = document.getElementById('alertModalTitle');
            const body = document.getElementById('alertModalBody');
            const image = document.getElementById('alertModalImage');
            const countdown = document.getElementById('alertModalCountdown');
            const link = document.getElementById('alertModalLink');

            // Configurar t√≠tulo
            if (alertData.title) {
                title.textContent = alertData.title;
            } else {
                title.textContent = 'Aviso Importante';
            }

            // Configurar corpo
            body.innerHTML = alertData.body_html;
            if (alertData.is_shouting) {
                body.classList.add('shouting');
            } else {
                body.classList.remove('shouting');
            }

            // Configurar imagem
            if (alertData.image_path) {
                image.src = `${API_URL}${alertData.image_path}`;
                image.style.display = 'block';
            } else {
                image.style.display = 'none';
            }

            // Configurar contagem regressiva
            if (alertData.has_countdown && alertData.countdown_ends_at) {
                startCountdown(alertData.countdown_ends_at, countdown);
                countdown.style.display = 'block';
            } else {
                countdown.style.display = 'none';
            }

            // Configurar link
            if (alertData.redirect_link) {
                link.href = alertData.redirect_link;
                link.style.display = 'inline-block';
            } else {
                link.style.display = 'none';
            }

            // Mostrar modal automaticamente
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            modal.classList.add('show');

            // Registrar visualiza√ß√£o
            recordAlertEvent(alertData.id, 'view');
        }

        // Fechar popup de avisos
        function fecharPopupAviso() {
            const modal = document.getElementById('alertModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            modal.classList.remove('show');
            
            if (currentAlert) {
                recordAlertEvent(currentAlert.id, 'close');
            }
        }

        // Esconder modal de avisos
        function hideAlertModal() {
            const modal = document.getElementById('alertModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            modal.classList.remove('show');
        }

        // Iniciar contagem regressiva
        function startCountdown(endTime, element) {
            function updateCountdown() {
                const agora = new Date();
                const fim = new Date(endTime);
                const diferenca = fim - agora;

                if (diferenca <= 0) {
                    element.textContent = '‚è∞ TEMPO ESGOTADO!';
                    element.style.background = 'linear-gradient(135deg, #6c757d, #495057)';
                    return;
                }

                const dias = Math.floor(diferenca / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diferenca % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((diferenca % (1000 * 60 * 60)) / (1000 * 60));
                const segundos = Math.floor((diferenca % (1000 * 60)) / 1000);

                let texto = '‚è≥ ';
                if (dias > 0) texto += `${dias} dia${dias > 1 ? 's' : ''} `;
                if (horas > 0 || dias > 0) texto += `${horas}h `;
                if (minutos > 0 || horas > 0 || dias > 0) texto += `${minutos}m `;
                texto += `${segundos}s`;

                element.textContent = texto;
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // Registrar evento do alerta
        async function recordAlertEvent(alertId, eventType) {
            try {
                await fetch(`${API_URL}/api/public/alerts/${alertId}/event`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ event_type: eventType })
                });
            } catch (error) {
                console.error('Erro ao registrar evento:', error);
            }
        }

        // Event listener para cliques no link do alerta
        document.addEventListener('click', function(e) {
            if (e.target.id === 'alertModalLink' && currentAlert) {
                recordAlertEvent(currentAlert.id, 'click');
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharPopupAviso();
            }
        });

        // Prevenir fechar clicando fora (mant√©m invasivo)
        document.getElementById('alertModal').addEventListener('click', function(e) {
            if (e.target === this) {
                // Opcional: pode remover esta linha se quiser permitir fechar clicando fora
                // fecharPopupAviso();
            }
        });
    </script>
</body>
</html>
